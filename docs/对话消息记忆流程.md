# 对话消息记忆流程

## 核心流程

### 首次对话/AiService缓存失效
1. 创建实例：getAiCodeGeneratorService发现Caffeine中没有于是创建
2. 读取历史并加载到内存窗口：loadChatHistoryToMemory从 MySQL消息表读取最近 20 条历史消息，再chatMemory.add()加载到 MessageWindowChatMemory内存消息窗口中（首次加载）
3. 内存消息同步到Store：由于配置了Store，消息会同步写入 Rediskey:appId
4. AI对话：
   a. 对话前框架先自动从 Store（Redis）读取消息到内存窗口中（重复加载）
   b. AI 处理请求并生成回复消息
   c. 将用户消息和 AI 响应消息保存到 MySQL
### 缓存命中
1. 从Caffeine直接获取AiService实例
2. AI对话：
   a. 对话前框架先自动从 Store（Redis）读取消息到内存窗口中
   b. AI 处理请求并生成回复消息
   c. 将用户消息和 AI 响应消息保存到 MySQL
## 消息存储流向

| 操作 | 读取 | 写入 |
|------|------|------|
| 创建 AI Service | MySQL | ChatMemory + Redis |
| AI 对话 | Redis | ChatMemory + Redis |
| 保存聊天记录 | - | MySQL |

## 滑动窗口

- **maxMessages: 20**（最多保留 10 轮对话）
- 超过 20 条时自动删除最旧消息
- Redis 中 1 小时后过期

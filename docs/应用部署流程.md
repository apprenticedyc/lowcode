# 应用部署流程

## 核心流程

1. **生成 deployKey**: 6位随机字符串 (例: a3b9c2)
2. **构建源目录路径**: `CODE_OUTPUT_ROOT_DIR/{codeGenType}_{appId}` (例: `tmp/multi_file_123/`)
3. **构建部署目录路径**: `CODE_DEPLOY_ROOT_DIR/{deployKey}` (例: `static_deploy/a3b9c2/`)
4. **复制文件**: `FileUtil.copyContent(源目录, 部署目录)`
5. **更新数据库**: 保存 `deployKey`, `deployedTime`
6. **返回部署 URL**: `{CODE_DEPLOY_HOST}/{deployKey}` (例: `http://localhost:8123/api/static/a3b9c2`)
7. **用户通过 URL 访问**: 浏览器请求 `http://localhost/{deployKey}`
8. **Nginx 静态资源服务器处理**: 监听80端口，将 `/{deployKey}/*` 请求映射到`CODE_DEPLOY_ROOT_DIR`下对应的`/{deployKey}/*` 文件并返回

## 流程时序图

## 目录结构

```bash
CODE_OUTPUT_ROOT_DIR/          # AI生成代码存储目录
└── MULTI_FILE_123/            # {type}_{appId}
    ├── index.html
    ├── css/
    └── js/
```
```bash
CODE_DEPLOY_ROOT_DIR/          # 部署目录
└── a3b9c2/                    # {deployKey}
    ├── index.html
    ├── css/
    └── js/
```

## Nginx 配置

```nginx
http {
    server {
        listen       80;
        server_name  localhost;
        charset      utf-8;

        # 项目部署根目录
        root         E:/XingQiuProject/ai-lowcode/tmp/code_deploy;

        # 处理所有请求 - 匹配 deployKey/文件路径
        location ~ ^/([^/]+)/(.*)$ {
            try_files /$1/$2 /$1/index.html =404;
        }
    }
}
```

### Nginx 处理流程

```
用户请求: http://localhost/a3b9c2/css/style.css
           ↓
Nginx 匹配 location: ~ ^/([^/]+)/(.*)$
           ↓
提取 deployKey = a3b9c2, 文件路径 = css/style.css
           ↓
try_files 依次尝试:
  1. /a3b9c2/css/style.css  ✓ 找到文件
           ↓
返回静态文件内容
```

| URL 请求 | Nginx 实际读取路径 |
|----------|-------------------|
| `http://localhost/a3b9c2` | `CODE_DEPLOY_ROOT_DIR/a3b9c2/index.html` |
| `http://localhost/a3b9c2/css/style.css` | `CODE_DEPLOY_ROOT_DIR/a3b9c2/css/style.css` |
| `http://localhost/a3b9c2/js/app.js` | `CODE_DEPLOY_ROOT_DIR/a3b9c2/js/app.js` |
